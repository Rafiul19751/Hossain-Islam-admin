<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Easy Earning Bot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --primary-color: #2ed914;
      --primary-hover: #3bff21;
      --secondary-color: #2a2a2e;
      --background-color: #1c1c1f;
      --text-color: #f0f0f0;
      --text-muted-color: #a0a0a0;
      --accent-color: #ff8c00;
      --card-bg: #252528;
      --danger-color: #ff4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; background-color: var(--background-color); color: var(--text-color);
      font-family: 'Segoe UI', 'Roboto', sans-serif; line-height: 1.6;
    }
    
    /* Professional login screen styling */
    .login-container {
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, var(--background-color), var(--secondary-color));
    }
    .login-card {
      background: var(--card-bg); padding: 40px; border-radius: 20px; width: 90%; max-width: 400px;
      border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    .login-header { text-align: center; margin-bottom: 30px; }
    .login-header h1 { color: var(--primary-color); margin: 0 0 10px; font-size: 2em; }
    .login-header p { color: var(--text-muted-color); margin: 0; }
    .login-form .form-group { margin-bottom: 20px; }
    .login-form input {
      width: 100%; padding: 15px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.1);
      background: var(--secondary-color); color: var(--text-color); font-size: 16px;
      transition: border-color 0.3s ease;
    }
    .login-form input:focus {
      outline: none; border-color: var(--primary-color);
    }
    .login-btn {
      width: 100%; padding: 15px; background: var(--primary-color); color: #000;
      border: none; border-radius: 10px; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; text-transform: uppercase;
    }
    .login-btn:hover { background: var(--primary-hover); transform: translateY(-2px); }
    .login-error {
      background: var(--danger-color); color: #fff; padding: 15px; border-radius: 10px;
      text-align: center; margin-top: 20px; display: none;
    }

    /* Hamburger menu styling */
    .admin-container { display: none; }
    .header {
      background: var(--card-bg); padding: 15px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100;
    }
    .header h1 { margin: 0; color: var(--primary-color); font-size: 1.5em; }
    .hamburger {
      background: none; border: none; color: var(--text-color); font-size: 1.5em;
      cursor: pointer; padding: 10px; border-radius: 8px; transition: all 0.3s ease;
    }
    .hamburger:hover { background: var(--secondary-color); color: var(--primary-color); }
    
    .sidebar {
      position: fixed; top: 0; left: -300px; width: 300px; height: 100vh;
      background: var(--card-bg); border-right: 1px solid rgba(255, 255, 255, 0.1);
      transition: left 0.3s ease; z-index: 200; overflow-y: auto;
    }
    .sidebar.active { left: 0; }
    .sidebar-header {
      padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex; align-items: center; justify-content: space-between;
    }
    .sidebar-header h2 { margin: 0; color: var(--primary-color); }
    .close-sidebar {
      background: none; border: none; color: var(--text-color); font-size: 1.5em;
      cursor: pointer; padding: 5px; border-radius: 5px;
    }
    .close-sidebar:hover { color: var(--danger-color); }
    
    .nav-menu { padding: 20px 0; }
    .nav-item {
      display: block; padding: 15px 20px; color: var(--text-color); text-decoration: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease;
    }
    .nav-item:hover, .nav-item.active {
      background: var(--primary-color); color: #000; padding-left: 30px;
    }
    .nav-item i { margin-right: 10px; width: 20px; }
    
    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 150; opacity: 0; visibility: hidden;
      transition: all 0.3s ease;
    }
    .overlay.active { opacity: 1; visibility: visible; }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card {
      background: linear-gradient(135deg, var(--primary-color), #00a651); padding: 20px;
      border-radius: 12px; text-align: center; color: #000;
    }
    .stat-card h3 { margin: 0; font-size: 2em; }
    .stat-card p { margin: 5px 0 0; opacity: 0.8; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card {
      background: var(--card-bg); padding: 25px; border-radius: 12px; margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .card h3 { margin-top: 0; color: var(--primary-color); }
    
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
      background: var(--secondary-color); color: var(--text-color); font-size: 14px;
    }
    .form-group textarea { resize: vertical; min-height: 100px; }
    .btn {
      padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer;
      font-weight: 600; transition: all 0.3s ease; text-transform: uppercase;
      letter-spacing: 0.5px; margin-right: 10px; margin-bottom: 10px;
    }
    .btn-primary { background: var(--primary-color); color: #000; }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }
    .btn-danger { background: var(--danger-color); color: #fff; }
    .btn-danger:hover { background: #ff6666; }
    .btn-secondary { background: var(--secondary-color); color: var(--text-color); }
    .btn-secondary:hover { background: #3a3a3e; }
    
    .table-container { overflow-x: auto; }
    .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .table th, .table td {
      padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .table th { background: var(--secondary-color); font-weight: 600; }
    .status-badge {
      padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
      text-transform: uppercase;
    }
    .status-pending { background: #ffa500; color: #000; }
    .status-approved { background: var(--primary-color); color: #000; }
    .status-rejected { background: var(--danger-color); color: #fff; }
    
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card-bg); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px;
      max-height: 80vh; overflow-y: auto;
    }
    .close-btn { float: right; font-size: 24px; cursor: pointer; color: var(--text-muted-color); }
    .close-btn:hover { color: var(--danger-color); }
    
    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .sidebar { width: 280px; }
    }
  </style>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, push, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Global variables
    let app, database;
    let appSettings = {}, users = {}, withdrawals = {}, earningTasks = {}, dailyTasks = {}, paymentMethods = {};

    function showLogin() {
        document.getElementById('login-container').style.display = 'flex';
        document.getElementById('admin-container').style.display = 'none';
    }

    function checkLogin() {
        const password = "Abcdwxzy@#$000111"; // Change this password
        const enteredPass = document.getElementById('admin-password').value;

        if (enteredPass === password) {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('admin-container').style.display = 'block';
            initializeFirebase();
        } else {
            document.getElementById('login-error').style.display = 'block';
            document.getElementById('login-error').textContent = 'Incorrect password. Please try again.';
        }
    }
    
    function initializeFirebase() {
        // --- Firebase Configuration ---
        // আপনার ফায়ারবেস কনফিগারেশন এখানে পেস্ট করুন।
        // Paste your Firebase configuration object here.
        const firebaseConfig = {
  apiKey: "AIzaSyClYOVa_2XAjCMselTO7z7QOnoVNlIwSpw",
  authDomain: "hoshin-islam.firebaseapp.com",
  databaseURL: "https://hoshin-islam-default-rtdb.firebaseio.com",
  projectId: "hoshin-islam",
  storageBucket: "hoshin-islam.firebasestorage.app",
  messagingSenderId: "650581385183",
  appId: "1:650581385183:web:dd1965f632aa514c392e6a",
  measurementId: "G-XS73HN52LB"
};
        // --- End of Firebase Configuration ---

        try {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                alert("Firebase configuration is missing. Please add it to admin.html in the initializeFirebase function.");
                return;
            }
            app = initializeApp(firebaseConfig, "admin-panel" + Date.now());
            database = getDatabase(app);
            initAdmin();
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Firebase configuration error. Please check your settings in the admin.html file.");
        }
    }
    
    document.addEventListener('DOMContentLoaded', showLogin);

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        
        document.getElementById(tabName).classList.add('active');
        document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
        
        closeSidebar();
    }

    async function initAdmin() {
      await Promise.all([
          loadAppSettings(), loadUsers(), loadWithdrawals(),
          loadEarningTasks(), loadDailyTasks(), loadPaymentMethods()
      ]);
      
      populateSettingsForm();
      updateStats();
      renderWithdrawals();
      renderEarningTasks();
      renderDailyTasks();
      renderPaymentMethods();
      renderUsers();
      
      onValue(ref(database, 'withdrawals'), (snapshot) => {
        withdrawals = snapshot.exists() ? snapshot.val() : {};
        renderWithdrawals();
        updateStats();
      });
      
      onValue(ref(database, 'users'), (snapshot) => {
        users = snapshot.exists() ? snapshot.val() : {};
        renderUsers();
        updateStats();
      });
    }

    async function loadAppSettings() {
      const snapshot = await get(ref(database, 'settings'));
      appSettings = snapshot.exists() ? snapshot.val() : {
          dailyCheckinReward: 0.001, 
          minWithdrawal: 5.00, 
          dailyVideoLimit: 10,
          botUsername: 'Easyearing99_bot',
          botName: 'Easy Earning Bot' // Default Bot Name
      };
    }
    async function loadUsers() {
      const snapshot = await get(ref(database, 'users'));
      users = snapshot.exists() ? snapshot.val() : {};
    }
    async function loadWithdrawals() {
      const snapshot = await get(ref(database, 'withdrawals'));
      withdrawals = snapshot.exists() ? snapshot.val() : {};
    }
    async function loadEarningTasks() {
      const snapshot = await get(ref(database, 'adTasks'));
      earningTasks = snapshot.exists() ? snapshot.val() : {};
    }
    async function loadDailyTasks() {
      const snapshot = await get(ref(database, 'dailyTasks'));
      dailyTasks = snapshot.exists() ? snapshot.val() : {};
    }
    async function loadPaymentMethods() {
      const snapshot = await get(ref(database, 'paymentMethods'));
      paymentMethods = snapshot.exists() ? snapshot.val() : {};
    }

    function populateSettingsForm() {
      document.getElementById('daily-checkin-reward').value = appSettings.dailyCheckinReward || 0;
      document.getElementById('min-withdrawal').value = appSettings.minWithdrawal || 0;
      document.getElementById('daily-video-limit').value = appSettings.dailyVideoLimit || 10;
      document.getElementById('bot-username').value = appSettings.botUsername || '';
      document.getElementById('bot-name').value = appSettings.botName || ''; // Populate bot name
    }

    function updateStats() {
      const totalUsers = Object.keys(users).length;
      const totalEarnings = Object.values(users).reduce((sum, user) => sum + (user.totalEarned || 0), 0);
      const pendingWithdrawals = Object.values(withdrawals).filter(w => w.status === 'pending').length;
      const totalWithdrawn = Object.values(withdrawals).filter(w => w.status === 'approved').reduce((sum, w) => sum + (w.amount || 0), 0);

      document.getElementById('total-users').textContent = totalUsers;
      document.getElementById('total-earnings').textContent = `$${totalEarnings.toFixed(4)}`;
      document.getElementById('pending-withdrawals').textContent = pendingWithdrawals;
      document.getElementById('total-withdrawals').textContent = `$${totalWithdrawn.toFixed(4)}`;
    }

    async function saveSettings() {
      try {
        const newSettings = {
          dailyCheckinReward: parseFloat(document.getElementById('daily-checkin-reward').value),
          minWithdrawal: parseFloat(document.getElementById('min-withdrawal').value),
          dailyVideoLimit: parseInt(document.getElementById('daily-video-limit').value),
          botUsername: document.getElementById('bot-username').value,
          botName: document.getElementById('bot-name').value // Save bot name
        };
        await set(ref(database, 'settings'), newSettings);
        appSettings = newSettings;
        alert('Settings saved successfully!');
      } catch (error) { alert('Error saving settings!'); }
    }
    
    // Earning Tasks Functions
    async function addEarningTask() {
      const title = document.getElementById('etask-title').value;
      const zoneId = document.getElementById('etask-url').value;
      const reward = parseFloat(document.getElementById('etask-reward').value);
      const delay = parseInt(document.getElementById('etask-delay').value);
      
      if (!title || !zoneId || isNaN(reward) || isNaN(delay)) { 
        alert('Please fill all fields correctly!'); 
        return; 
      }
      
      if (reward <= 0 || reward > 1) {
        alert('Reward must be between $0.0001 and $1.0000');
        return;
      }
      
      try {
        await push(ref(database, 'adTasks'), { 
          title, 
          zoneId, 
          reward, 
          delay, 
          createdAt: new Date().toISOString() 
        });
        
        document.getElementById('etask-title').value = ''; 
        document.getElementById('etask-url').value = '';
        document.getElementById('etask-reward').value = ''; 
        document.getElementById('etask-delay').value = '15';
        
        await loadEarningTasks(); 
        renderEarningTasks(); 
        alert('✅ Video advertisement task added successfully!');
      } catch (error) { 
        console.error('Error adding task:', error);
        alert('❌ Error adding task! Please try again.'); 
      }
    }
    function renderEarningTasks() {
      const container = document.getElementById('earning-tasks-list');
      container.innerHTML = !earningTasks || Object.keys(earningTasks).length === 0 ? 
        '<p style="text-align: center; color: var(--text-muted-color); padding: 20px;">No video advertisement tasks found. Add your first task above!</p>' :
        Object.entries(earningTasks).map(([id, task]) => `
          <div class="card" style="border-left: 4px solid var(--primary-color);">
            <h4><i class="fa-solid fa-rectangle-ad"></i> ${task.title}</h4>
            <p><strong>Zone ID:</strong> <code>${task.zoneId}</code></p>
            <p><strong>Reward:</strong> <span style="color: var(--primary-color); font-weight: bold;">$${task.reward.toFixed(4)}</span> | <strong>Verification Delay:</strong> ${task.delay} seconds</p>
            <p><strong>Created:</strong> ${new Date(task.createdAt).toLocaleDateString()}</p>
            <button class="btn btn-danger" onclick="deleteEarningTask('${id}')">
              <i class="fa-solid fa-trash"></i> Delete Task
            </button>
          </div>`).join('');
    }
    async function deleteEarningTask(taskId) {
      if (!confirm('⚠️ Are you sure you want to delete this video advertisement task?\n\nThis action cannot be undone.')) return;
      try {
        await remove(ref(database, `adTasks/${taskId}`));
        await loadEarningTasks(); 
        renderEarningTasks(); 
        alert('✅ Video advertisement task deleted successfully!');
      } catch (error) { 
        console.error('Error deleting task:', error);
        alert('❌ Error deleting task! Please try again.'); 
      }
    }

    // Daily Tasks Functions
    async function addDailyTask() {
      const title = document.getElementById('dtask-title').value;
      const url = document.getElementById('dtask-url').value;
      const reward = parseFloat(document.getElementById('dtask-reward').value);
      const delay = parseInt(document.getElementById('dtask-delay').value);
      if (!title || !url || isNaN(reward) || isNaN(delay)) { alert('Please fill all fields!'); return; }
      try {
        await push(ref(database, 'dailyTasks'), { title, url, reward, delay, createdAt: new Date().toISOString() });
        document.getElementById('dtask-title').value = ''; document.getElementById('dtask-url').value = '';
        document.getElementById('dtask-reward').value = ''; document.getElementById('dtask-delay').value = '10';
        await loadDailyTasks(); renderDailyTasks(); alert('Daily task added!');
      } catch (error) { alert('Error adding task!'); }
    }
    function renderDailyTasks() {
      const container = document.getElementById('daily-tasks-list');
      container.innerHTML = !dailyTasks || Object.keys(dailyTasks).length === 0 ? '<p>No daily tasks found.</p>' :
        Object.entries(dailyTasks).map(([id, task]) => `
          <div class="card"><h4>${task.title}</h4><p><strong>URL/Action:</strong> ${task.url}</p>
            <p><strong>Reward:</strong> $${task.reward.toFixed(4)} | <strong>Delay:</strong> ${task.delay}s</p>
            <button class="btn btn-danger" onclick="deleteDailyTask('${id}')">Delete</button></div>`).join('');
    }
    async function deleteDailyTask(taskId) {
      if (!confirm('Delete this task?')) return;
      try {
        await remove(ref(database, `dailyTasks/${taskId}`));
        await loadDailyTasks(); renderDailyTasks(); alert('Task deleted!');
      } catch (error) { alert('Error deleting task!'); }
    }
    
    // Payment Methods Functions
    async function addPaymentMethod() {
        const name = document.getElementById('method-name').value, code = document.getElementById('method-code').value;
        if (!name || !code) { alert('Please fill all fields!'); return; }
        try {
            await push(ref(database, 'paymentMethods'), { name, code });
            document.getElementById('method-name').value = ''; document.getElementById('method-code').value = '';
            await loadPaymentMethods(); renderPaymentMethods(); alert('Payment method added!');
        } catch (error) { alert('Error adding method!'); }
    }
    function renderPaymentMethods() {
        const container = document.getElementById('payment-methods-list');
        container.innerHTML = !paymentMethods || Object.keys(paymentMethods).length === 0 ? '<p>No methods found.</p>' :
          Object.entries(paymentMethods).map(([id, method]) => `<div class="card"><h4>${method.name}</h4><p><strong>Code:</strong> ${method.code}</p>
              <button class="btn btn-danger" onclick="deletePaymentMethod('${id}')">Delete</button></div>`).join('');
    }
    async function deletePaymentMethod(methodId) {
        if (!confirm('Delete this method?')) return;
        try {
            await remove(ref(database, `paymentMethods/${methodId}`));
            await loadPaymentMethods(); renderPaymentMethods(); alert('Method deleted!');
        } catch (error) { alert('Error deleting method!'); }
    }

    function renderWithdrawals() {
      const container = document.getElementById('withdrawals-list');
      if (!withdrawals || Object.keys(withdrawals).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted-color); padding: 20px;">No withdrawal requests found.</p>'; 
        return;
      }
      
      const withdrawalArray = Object.entries(withdrawals).reverse();
      
      container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th><i class="fa-solid fa-user"></i> User</th>
                <th><i class="fa-solid fa-credit-card"></i> Method</th>
                <th><i class="fa-solid fa-dollar-sign"></i> Amount</th>
                <th><i class="fa-solid fa-wallet"></i> Wallet</th>
                <th><i class="fa-solid fa-info-circle"></i> Status</th>
                <th><i class="fa-solid fa-calendar"></i> Date</th>
                <th><i class="fa-solid fa-cogs"></i> Actions</th>
              </tr>
            </thead>
            <tbody>
              ${withdrawalArray.map(([id, w]) => `
                <tr style="border-left: 4px solid ${w.status === 'pending' ? 'var(--accent-color)' : w.status === 'approved' ? 'var(--primary-color)' : 'var(--danger-color)'};">
                  <td>
                    <strong>${w.firstName || 'N/A'}</strong><br>
                    <small style="color: var(--text-muted-color);">@${w.username || 'N/A'}</small>
                  </td>
                  <td><span style="background: var(--secondary-color); padding: 4px 8px; border-radius: 4px; font-family: monospace;">${w.currency}</span></td>
                  <td><strong style="color: var(--primary-color);">$${w.amount.toFixed(4)}</strong></td>
                  <td>
                    <code style="font-size: 0.8em; background: var(--secondary-color); padding: 2px 4px; border-radius: 3px;" title="${w.walletAddress}">
                      ${(w.walletAddress || '').substring(0, 20)}${(w.walletAddress || '').length > 20 ? '...' : ''}
                    </code>
                  </td>
                  <td><span class="status-badge status-${w.status}">${w.status.toUpperCase()}</span></td>
                  <td>
                    <strong>${new Date(w.timestamp).toLocaleDateString()}</strong><br>
                    <small style="color: var(--text-muted-color);">${new Date(w.timestamp).toLocaleTimeString()}</small>
                  </td>
                  <td>
                    ${w.status === 'pending' ? `
                      <button class="btn btn-primary" onclick="approveWithdrawal('${id}')" title="Approve this withdrawal">
                        <i class="fa-solid fa-check"></i> Approve
                      </button>
                      <button class="btn btn-danger" onclick="rejectWithdrawal('${id}')" title="Reject and refund">
                        <i class="fa-solid fa-times"></i> Reject
                      </button>
                    ` : ''}
                    <button class="btn btn-secondary" onclick="viewWithdrawalDetails('${id}')" title="View full details">
                      <i class="fa-solid fa-eye"></i> View
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    async function approveWithdrawal(id) {
      if (!confirm('✅ Approve this withdrawal request?\n\nMake sure you have processed the payment before approving.')) return;
      try {
        await update(ref(database, `withdrawals/${id}`), { 
          status: 'approved', 
          processedAt: new Date().toISOString(),
          processedBy: 'admin'
        });
        
        const w = withdrawals[id];
        await push(ref(database, `history/${w.userId}`), { 
          type: 'withdraw', 
          detail: `✅ Withdrawal approved: $${w.amount.toFixed(4)} (${w.currency}) - Payment processed`, 
          timestamp: new Date().toISOString() 
        });
        
        alert('✅ Withdrawal approved successfully!\n\nThe user has been notified of the approval.');
      } catch (error) { 
        console.error('Error approving withdrawal:', error);
        alert('❌ Error approving withdrawal! Please try again.'); 
      }
    }

    async function rejectWithdrawal(id) {
      const reason = prompt('❌ Please enter the reason for rejection:\n\n(This will be shown to the user)') || 'No reason provided';
      
      if (!confirm(`⚠️ Reject this withdrawal and refund the amount?\n\nReason: ${reason}\n\nThe user's balance will be restored.`)) return;
      
      try {
        await update(ref(database, `withdrawals/${id}`), { 
          status: 'rejected', 
          rejectionReason: reason, 
          processedAt: new Date().toISOString(),
          processedBy: 'admin'
        });
        
        const w = withdrawals[id];
        const userRef = ref(database, `users/${w.userId}`);
        const userSnapshot = await get(userRef);
        
        if (userSnapshot.exists()) {
          const currentBalance = userSnapshot.val().balance || 0;
          await update(userRef, { balance: currentBalance + w.amount });
        }
        
        await push(ref(database, `history/${w.userId}`), { 
          type: 'withdraw', 
          detail: `❌ Withdrawal rejected & refunded: $${w.amount.toFixed(4)} - Reason: ${reason}`, 
          timestamp: new Date().toISOString() 
        });
        
        alert('✅ Withdrawal rejected and balance refunded successfully!\n\nThe user has been notified with the reason.');
      } catch (error) { 
        console.error('Error rejecting withdrawal:', error);
        alert('❌ Error rejecting withdrawal! Please try again.'); 
      }
    }

    function renderUsers() {
      const container = document.getElementById('users-list');
      if (!users || Object.keys(users).length === 0) { container.innerHTML = '<p>No users found.</p>'; return; }
      const userArray = Object.values(users).sort((a, b) => (b.totalEarned || 0) - (a.totalEarned || 0));
      container.innerHTML = `<div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Username</th><th>Balance</th><th>Total Earned</th><th>Join Date</th><th>Actions</th></tr></thead><tbody>
        ${userArray.map(u => `<tr><td>${u.firstName || 'N/A'}</td><td>@${u.username || 'N/A'}</td><td>$${(u.balance || 0).toFixed(4)}</td><td>$${(u.totalEarned || 0).toFixed(4)}</td><td>${new Date(u.joinDate).toLocaleDateString()}</td><td><button class="btn btn-secondary" onclick="editUser('${u.id}')">Edit</button></td></tr>`).join('')}</tbody></table></div>`;
    }

    function editUser(userId) {
      const user = users[userId]; if (!user) return;
      document.getElementById('edit-user-id').value = userId;
      document.getElementById('edit-balance').value = user.balance || 0;
      document.getElementById('edit-total-earned').value = user.totalEarned || 0;
      document.getElementById('edit-user-modal').classList.add('active');
    }

    async function saveUserChanges() {
      const userId = document.getElementById('edit-user-id').value;
      const newBalance = parseFloat(document.getElementById('edit-balance').value);
      const newTotalEarned = parseFloat(document.getElementById('edit-total-earned').value);
      try {
        await update(ref(database, `users/${userId}`), { balance: newBalance, totalEarned: newTotalEarned });
        await loadUsers(); renderUsers(); updateStats(); closeModal('edit-user-modal');
        alert('User updated!');
      } catch (error) { alert('Error updating user!'); }
    }

    function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
    function viewWithdrawalDetails(id) {
      const w = withdrawals[id]; if (!w) return;
      document.getElementById('details-modal-content').innerHTML = `<h3>Withdrawal Details</h3><p><strong>User:</strong> ${w.firstName || '@' + w.username}</p><p><strong>Amount:</strong> $${w.amount.toFixed(4)}</p><p><strong>Method:</strong> ${w.currency}</p><p><strong>Details:</strong> <code style="word-break: break-all;">${w.walletAddress}</code></p><p><strong>Status:</strong> <span class="status-badge status-${w.status}">${w.status.toUpperCase()}</span></p><p><strong>Date:</strong> ${new Date(w.timestamp).toLocaleString()}</p>${w.rejectionReason ? `<p><strong>Reason:</strong> ${w.rejectionReason}</p>` : ''}<button class="btn btn-secondary" onclick="closeModal('details-modal')">Close</button>`;
      document.getElementById('details-modal').classList.add('active');
    }

    // Make functions global
    window.checkLogin = checkLogin;
    window.toggleSidebar = toggleSidebar;
    window.closeSidebar = closeSidebar;
    window.showTab = showTab; window.saveSettings = saveSettings;
    window.addEarningTask = addEarningTask; window.deleteEarningTask = deleteEarningTask;
    window.addDailyTask = addDailyTask; window.deleteDailyTask = deleteDailyTask;
    window.addPaymentMethod = addPaymentMethod; window.deletePaymentMethod = deletePaymentMethod;
    window.approveWithdrawal = approveWithdrawal; window.rejectWithdrawal = rejectWithdrawal;
    window.editUser = editUser; window.saveUserChanges = saveUserChanges;
    window.closeModal = closeModal;
    window.viewWithdrawalDetails = viewWithdrawalDetails;
  </script>
</head>
<body>
  <!-- Professional login screen -->
  <div id="login-container" class="login-container">
    <div class="login-card">
      <div class="login-header">
        <h1><i class="fa-solid fa-shield-halved"></i> Admin Access</h1>
        <p>Easy Earning Bot Management System</p>
      </div>
      <div class="login-form">
        <div class="form-group">
          <input type="password" id="admin-password" placeholder="Enter admin password" />
        </div>
        <button class="login-btn" onclick="checkLogin()">
          <i class="fa-solid fa-sign-in-alt"></i> Access Admin Panel
        </button>
        <div id="login-error" class="login-error"></div>
      </div>
    </div>
  </div>

  <!-- Hamburger menu layout -->
  <div id="admin-container" class="admin-container">
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
    
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2><i class="fa-solid fa-cog"></i> Admin Panel</h2>
        <button class="close-sidebar" onclick="closeSidebar()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <nav class="nav-menu">
        <a href="#" class="nav-item active" onclick="showTab('dashboard-tab')">
          <i class="fa-solid fa-chart-line"></i> Dashboard
        </a>
        <a href="#" class="nav-item" onclick="showTab('settings-tab')">
          <i class="fa-solid fa-cog"></i> Settings
        </a>
        <a href="#" class="nav-item" onclick="showTab('withdrawals-tab')">
          <i class="fa-solid fa-money-bill-transfer"></i> Withdrawals
        </a>
        <a href="#" class="nav-item" onclick="showTab('earning-tasks-tab')">
          <i class="fa-solid fa-rectangle-ad"></i> Video Ads
        </a>
        <a href="#" class="nav-item" onclick="showTab('daily-tasks-tab')">
          <i class="fa-solid fa-list-check"></i> Daily Tasks
        </a>
        <a href="#" class="nav-item" onclick="showTab('payments-tab')">
          <i class="fa-solid fa-credit-card"></i> Payment Methods
        </a>
        <a href="#" class="nav-item" onclick="showTab('users-tab')">
          <i class="fa-solid fa-users"></i> Users
        </a>
      </nav>
    </div>

    <div class="header">
      <button class="hamburger" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </button>
      <h1>Easy Earning Bot Admin</h1>
    </div>

    <div class="container">
      <!-- Dashboard tab as default -->
      <div id="dashboard-tab" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card"><h3 id="total-users">0</h3><p>Total Users</p></div>
          <div class="stat-card"><h3 id="total-earnings">$0.0000</h3><p>Total Earnings</p></div>
          <div class="stat-card"><h3 id="pending-withdrawals">0</h3><p>Pending Withdrawals</p></div>
          <div class="stat-card"><h3 id="total-withdrawals">$0.0000</h3><p>Total Withdrawn</p></div>
        </div>
        <div class="card">
          <h3><i class="fa-solid fa-chart-line"></i> System Overview</h3>
          <p>Welcome to the Easy Earning Bot admin panel. Use the menu to navigate between different sections and manage your bot.</p>
        </div>
      </div>

      <div id="settings-tab" class="tab-content">
        <div class="card"><h3><i class="fa-solid fa-cog"></i> Application Settings</h3><div class="form-grid">
          <div class="form-group"><label for="bot-name">Bot Name</label><input type="text" id="bot-name" placeholder="Your Bot Name"></div>
          <div class="form-group"><label for="bot-username">Telegram Bot Username</label><input type="text" id="bot-username" placeholder="Easyearing99_bot"></div>
          <div class="form-group"><label for="daily-checkin-reward">Daily Check-in Reward ($)</label><input type="number" id="daily-checkin-reward" step="0.001" placeholder="0.001"></div>
          <div class="form-group"><label for="min-withdrawal">Minimum Withdrawal Amount ($)</label><input type="number" id="min-withdrawal" step="0.01" placeholder="5.00"></div>
          <div class="form-group"><label for="daily-video-limit">Daily Video Ads Limit (per user)</label><input type="number" id="daily-video-limit" min="1" max="100" placeholder="10"></div>
        </div><button class="btn btn-primary" onclick="saveSettings()"><i class="fa-solid fa-save"></i> Save All Settings</button></div>
      </div>

      <div id="withdrawals-tab" class="tab-content">
        <div class="card"><h3><i class="fa-solid fa-money-bill-transfer"></i> User Withdrawal Requests</h3><div id="withdrawals-list"><p>Loading withdrawal requests...</p></div></div>
      </div>

      <div id="earning-tasks-tab" class="tab-content">
        <div class="card">
          <h3><i class="fa-solid fa-plus"></i> Add New Video Advertisement Task</h3>
          <p style="color: var(--text-muted-color); margin-bottom: 20px;">
            <i class="fa-solid fa-info-circle"></i> Create video advertisement tasks that users can watch to earn money. Each user can watch up to the daily limit you set.
          </p>
          <div class="form-grid">
            <div class="form-group">
              <label for="etask-title">Advertisement Title</label>
              <input type="text" id="etask-title" placeholder="e.g., Watch Short Video Ad #1">
            </div>
            <div class="form-group">
              <label for="etask-url">Advertisement Zone ID</label>
              <input type="text" id="etask-url" placeholder="e.g., 7138351 (from ad network)">
            </div>
            <div class="form-group">
              <label for="etask-reward">Reward Amount ($)</label>
              <input type="number" id="etask-reward" step="0.0001" placeholder="0.0050" min="0.0001" max="1.0000">
            </div>
            <div class="form-group">
              <label for="etask-delay">Verification Delay (seconds)</label>
              <input type="number" id="etask-delay" placeholder="15" value="15" min="5" max="60">
            </div>
          </div>
          <button class="btn btn-primary" onclick="addEarningTask()">
            <i class="fa-solid fa-plus"></i> Add Advertisement Task
          </button>
        </div>
        <div class="card">
          <h3><i class="fa-solid fa-list"></i> Active Video Advertisement Tasks</h3>
          <div id="earning-tasks-list"><p>Loading advertisement tasks...</p></div>
        </div>
      </div>
      
      <div id="daily-tasks-tab" class="tab-content">
        <div class="card"><h3><i class="fa-solid fa-plus"></i> Add New Daily Bonus Task</h3><div class="form-grid">
            <div class="form-group"><label for="dtask-title">Task Title</label><input type="text" id="dtask-title" placeholder="e.g., Join Our Telegram Channel"></div>
            <div class="form-group"><label for="dtask-url">Task URL or Action</label><input type="text" id="dtask-url" placeholder="e.g., https://t.me/yourchannel"></div>
            <div class="form-group"><label for="dtask-reward">Reward Amount ($)</label><input type="number" id="dtask-reward" step="0.0001" placeholder="0.0100"></div>
            <div class="form-group"><label for="dtask-delay">Verification Delay (seconds)</label><input type="number" id="dtask-delay" placeholder="10" value="10"></div>
        </div><button class="btn btn-primary" onclick="addDailyTask()"><i class="fa-solid fa-plus"></i> Add Daily Task</button></div>
        <div class="card"><h3><i class="fa-solid fa-list"></i> Active Daily Bonus Tasks</h3><div id="daily-tasks-list"><p>Loading daily tasks...</p></div></div>
      </div>
      
      <div id="payments-tab" class="tab-content">
        <div class="card"><h3><i class="fa-solid fa-plus"></i> Add New Payment Method</h3><div class="form-grid">
            <div class="form-group"><label for="method-name">Payment Method Name</label><input type="text" id="method-name" placeholder="e.g., Bitcoin (BTC)"></div>
            <div class="form-group"><label for="method-code">Currency Code/Ticker</label><input type="text" id="method-code" placeholder="e.g., BTC"></div>
        </div><button class="btn btn-primary" onclick="addPaymentMethod()"><i class="fa-solid fa-plus"></i> Add Payment Method</button></div>
        <div class="card"><h3><i class="fa-solid fa-list"></i> Available Payment Methods</h3><div id="payment-methods-list"><p>Loading payment methods...</p></div></div>
      </div>

      <div id="users-tab" class="tab-content">
        <div class="card"><h3><i class="fa-solid fa-users"></i> User Account Management</h3><div id="users-list"><p>Loading user accounts...</p></div></div>
      </div>
    </div>

    <div id="edit-user-modal" class="modal">
      <div class="modal-content"><span class="close-btn" onclick="closeModal('edit-user-modal')">&times;</span>
      <h3>Edit User Account</h3><input type="hidden" id="edit-user-id">
        <div class="form-group"><label for="edit-balance">Current Balance ($)</label><input type="number" id="edit-balance" step="0.0001"></div>
        <div class="form-group"><label for="edit-total-earned">Total Earnings ($)</label><input type="number" id="edit-total-earned" step="0.0001"></div>
        <button class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button><button class="btn btn-secondary" onclick="closeModal('edit-user-modal')">Cancel</button>
      </div>
    </div>
    <div id="details-modal" class="modal"><div class="modal-content" id="details-modal-content"></div></div>
  </div>
</body>
</html>
